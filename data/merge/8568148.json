{"updated_at": "2012-09-14T17:03:42Z", "repo": "rails", "created_at": "2012-09-14T17:03:42Z", "owner": "rails", "url": "https://api.github.com/repos/rails/rails/issues/comments/8568148", "id": 8568148, "issue_url": "https://api.github.com/repos/rails/rails/issues/7631", "issue_id": 7631, "user": {"repos_url": "https://api.github.com/users/wlipa/repos", "type": "User", "html_url": "https://github.com/wlipa", "starred_url": "https://api.github.com/users/wlipa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wlipa/subscriptions", "following_url": "https://api.github.com/users/wlipa/following{/other_user}", "gravatar_id": "af05034b45cfa51686301b21ad2357c8", "organizations_url": "https://api.github.com/users/wlipa/orgs", "url": "https://api.github.com/users/wlipa", "gists_url": "https://api.github.com/users/wlipa/gists{/gist_id}", "avatar_url": "https://1.gravatar.com/avatar/af05034b45cfa51686301b21ad2357c8?d=https%3A%2F%2Fidenticons.github.com%2F71f58dc2f5a3d2be62f3f85625ff0bda.png", "id": 15970, "events_url": "https://api.github.com/users/wlipa/events{/privacy}", "login": "wlipa", "received_events_url": "https://api.github.com/users/wlipa/received_events", "followers_url": "https://api.github.com/users/wlipa/followers"}, "body": "Here are instructions for replicating from scratch in a new app.\n\n```\nrails new querypig -d mysql\nrails generate model MyModel user_id:integer kind:integer product_id:integer comment_id:integer duration:integer category_id:integer ip:string leaderboard_id:integer status_id:integer description:string\nrake db:create db:migrate\n```\n\nPopulate the database:\n```\n10000.times do\n  MyModel.create({\n    :user_id => rand(1..100),\n    :kind => rand(1..100),\n    :product_id => rand(1..100),\n    :comment_id => rand(1..100),\n    :duration => rand(1..100),\n    :category_id => rand(1..100),\n    :ip => rand(1..100).to_s,\n    :leaderboard_id => rand(1..100),\n    :status_id => rand(1..100),\n    :description => rand(1..100).to_s,\n  })\nend\n```\n\nMeasure the memory usage:\n```\ndef resident_mb\n  `ps -o rss= -p #{Process.pid}`.to_i / 1.kilobyte\nend\n\ndef stats\n  GC.start\n  rmb = resident_mb\n  puts \"pid #{Process.pid} rss: #{rmb}m gc: #{GC.stat}\"\n  rmb\nend\n\n\n# preflight\nMyModel.first\n\ninitial_rss = cur_rss = stats\n\n8.times do \n  # potentially piggish\n  mm = MyModel.all\n  cur_rss = stats\nend\n\nputs \"rss delta: #{cur_rss - initial_rss}\"\n```\n\nI did that by sticking the above in script/measure.rb and using the command \"rails runner script/measure.rb\". On OSX I consistently got a delta of right near 18m with the patch, and a varying but always larger amount between 25-41m without it.\n", "_id": {"$oid": "5237f9a0bd3543c15100b4b0"}, "html_url": "https://github.com/rails/rails/pull/7631#issuecomment-8568148"}
