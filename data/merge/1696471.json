{"body": "Had time to investigate more in this issue. This call \"to early\" isn\u00b4t to early (I just borrowed this term from the issue description), it is and always has been necessary (see comment above) as of this: When you define 'default_url_options' in a controller every link that uses a url helper (e.g. 'people_path') automatically includes the specified defaults as query string parameters. Now consider a typical functional test with a get on the index action: \r\n\r\n```ruby\r\nclass PeopleControllerTest < ActionController::TestCase\r\n    ...\r\n    get :index # no explicit parameters needed! \r\n    ...\r\n  end\r\nend\r\n\r\n```\r\n\r\nIn the application a link to the index action using an url helper would be rewritten to include the specified defaults which you don\u00b4t have to pass explicitly in tests. In order to derive a controller\u00b4s default params and to simulte the proper environment in the testsuite the call to 'build_request_uri' must trigger 'url_options' (and then 'default_url_options'). This is what was called \"to early\" all the time but in fact it isn\u00b4t.\r\n\r\nNow, when combining default_url_options with a before_filter (as in the issue description) the situation becomes more complicated as the before_filter uses I18n to indirectly modify the result of default_url_options. But this modified result is invisible to the application as of caching the first call. Please note that all my above mentioned points still apply, too. \r\n\r\nIf hope this pull request is now ok for you. If it is I\u00b4ll provide one for master, too. ", "url": "https://api.github.com/repos/rails/rails/issues/comments/1696471", "created_at": "2011-07-31T20:45:47Z", "html_url": "https://github.com/rails/rails/pull/2307#issuecomment-1696471", "updated_at": "2011-07-31T20:49:59Z", "repo": "rails", "issue_id": 2307, "user": {"following_url": "https://api.github.com/users/thoefer/following{/other_user}", "events_url": "https://api.github.com/users/thoefer/events{/privacy}", "organizations_url": "https://api.github.com/users/thoefer/orgs", "url": "https://api.github.com/users/thoefer", "gists_url": "https://api.github.com/users/thoefer/gists{/gist_id}", "html_url": "https://github.com/thoefer", "subscriptions_url": "https://api.github.com/users/thoefer/subscriptions", "avatar_url": "https://1.gravatar.com/avatar/7c33b1ba3982f3573b526154736f43d8?d=https%3A%2F%2Fidenticons.github.com%2F63f1ae8fda9bccaffd34c095af8c4c35.png", "repos_url": "https://api.github.com/users/thoefer/repos", "received_events_url": "https://api.github.com/users/thoefer/received_events", "gravatar_id": "7c33b1ba3982f3573b526154736f43d8", "starred_url": "https://api.github.com/users/thoefer/starred{/owner}{/repo}", "login": "thoefer", "type": "User", "id": 202410, "followers_url": "https://api.github.com/users/thoefer/followers"}, "owner": "rails", "_id": {"$oid": "523844f8bd3543c151010d9c"}, "id": 1696471, "issue_url": "https://api.github.com/repos/rails/rails/issues/2307"}
