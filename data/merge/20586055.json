{"issue_url": "https://api.github.com/repos/rails/rails/issues/11353", "repo": "rails", "body": "In the change to actionpack/lib/action_dispatch/middleware/params_parser.rb, request.body is changed to request.raw_post as so:\r\n\r\n\\-          data = ActiveSupport::JSON.decode(request.body)\r\n\\+          data = ActiveSupport::JSON.decode(request.raw_post)\r\n\r\n... but the pull request comment says:\r\n\r\n\"In order to get raw_post to be not empty after ParamsParser#parse_formatted_parameters, added rewinding of body stream input.\"\r\n\r\nSo I think you meant to call request.body.rewind instead of changing JSON.decode(request.body) to JSON.decode(request.raw_post)\r\n\r\nI just tested rewinding the request body in actionpack-4.0.0/lib/action_dispatch/middleware/params_parser.rb and ran the curl test with Rails 4.0.0 and Ruby 2.0.0-p247 and the test now passes. Here is the code in params_parser.rb:\r\n\r\n        case strategy\r\n        when Proc\r\n          strategy.call(request.raw_post)\r\n        when :json\r\n          data = ActiveSupport::JSON.decode(request.body)\r\n          request.body.rewind if request.body.respond_to?(:rewind)\r\n          data = {:_json => data} unless data.is_a?(Hash)\r\n          request.deep_munge(data).with_indifferent_access\r\n        else\r\n          false\r\n        end\r\n\r\n... and here is the result of the test:\r\n\r\nProcessing by PostsController#create as */*\r\n  Parameters: {\"post\"=>{\"title\"=>\"my title\"}}\r\nthis is request.raw_post = \r\n{\"post\":{\"title\":\"my title\"}}\r\nthis is request.params = {\"post\"=>{\"title\"=>\"my title\"}, \"action\"=>\"create\", \"controller\"=>\"posts\"}\r\n  Rendered text template (0.0ms)\r\n\r\n============================================\r\n\r\n", "_id": {"$oid": "5237d5ccbd3543c15100823a"}, "issue_id": 11353, "url": "https://api.github.com/repos/rails/rails/issues/comments/20586055", "html_url": "https://github.com/rails/rails/pull/11353#issuecomment-20586055", "updated_at": "2013-07-08T05:18:58Z", "user": {"subscriptions_url": "https://api.github.com/users/Alamoz/subscriptions", "events_url": "https://api.github.com/users/Alamoz/events{/privacy}", "repos_url": "https://api.github.com/users/Alamoz/repos", "gists_url": "https://api.github.com/users/Alamoz/gists{/gist_id}", "url": "https://api.github.com/users/Alamoz", "login": "Alamoz", "gravatar_id": "acfe9766803c7317f1143d919755d016", "html_url": "https://github.com/Alamoz", "following_url": "https://api.github.com/users/Alamoz/following{/other_user}", "received_events_url": "https://api.github.com/users/Alamoz/received_events", "organizations_url": "https://api.github.com/users/Alamoz/orgs", "avatar_url": "https://0.gravatar.com/avatar/acfe9766803c7317f1143d919755d016?d=https%3A%2F%2Fidenticons.github.com%2Fb9293e1a3e6919cf510a787da16875fd.png", "starred_url": "https://api.github.com/users/Alamoz/starred{/owner}{/repo}", "id": 905505, "followers_url": "https://api.github.com/users/Alamoz/followers", "type": "User"}, "created_at": "2013-07-08T05:17:13Z", "id": 20586055, "owner": "rails"}
