{"updated_at": "2011-08-20T08:31:38Z", "repo": "rails", "created_at": "2011-08-20T08:31:38Z", "owner": "rails", "url": "https://api.github.com/repos/rails/rails/issues/comments/1858726", "id": 1858726, "issue_url": "https://api.github.com/repos/rails/rails/issues/2490", "issue_id": 2490, "user": {"repos_url": "https://api.github.com/users/adamcrown/repos", "type": "User", "html_url": "https://github.com/adamcrown", "starred_url": "https://api.github.com/users/adamcrown/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/adamcrown/subscriptions", "following_url": "https://api.github.com/users/adamcrown/following{/other_user}", "gravatar_id": "8e376bdb110a47cc06658bf84d46d515", "organizations_url": "https://api.github.com/users/adamcrown/orgs", "url": "https://api.github.com/users/adamcrown", "gists_url": "https://api.github.com/users/adamcrown/gists{/gist_id}", "avatar_url": "https://1.gravatar.com/avatar/8e376bdb110a47cc06658bf84d46d515?d=https%3A%2F%2Fidenticons.github.com%2Fa0d85a3e1a35b95531490bbd86e87c34.png", "id": 277306, "events_url": "https://api.github.com/users/adamcrown/events{/privacy}", "login": "adamcrown", "received_events_url": "https://api.github.com/users/adamcrown/received_events", "followers_url": "https://api.github.com/users/adamcrown/followers"}, "body": "The `@trusted_proxies` regexp is correct in that it matches any IP addresses that are reserved for LANs like 192.168.*.* or 10.*.*.*. The problem is, if the client happens to be connecting from the LAN and has an IP address like 192.168.0.10, it will be rejected from the `forwarded_ips` array, resulting in an empty array, and the `REMOTE_ADDR` header winds up getting returned. And the `REMOTE_ADDR` is the IP for the proxy, not the client.\r\n\r\nSo the end result we're seeing in our app (which is being reverse proxied, with both the proxy server and the app server being hosted on the LAN) is that `request.remote_ip` returns the correct IP for clients connecting over the internet, but clients within our network are being seen as having the proxy's IP.\r\n\r\nFor a while I thought I could just set `trusted_ips` to our proxy server's exact IP only, but it turns out you can't overwrite the regular expression used to find trusted proxies, you can only add to it. So at the moment we're just grabbing `request.headers['X_FORWARDED_FOR']` directly.", "_id": {"$oid": "52384314bd3543c151010ba2"}, "html_url": "https://github.com/rails/rails/pull/2490#issuecomment-1858726"}
