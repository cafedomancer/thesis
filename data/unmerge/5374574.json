{"updated_at": "2012-04-27T06:09:53Z", "repo": "rails", "created_at": "2012-04-27T06:05:56Z", "owner": "rails", "url": "https://api.github.com/repos/rails/rails/issues/comments/5374574", "id": 5374574, "issue_url": "https://api.github.com/repos/rails/rails/issues/2924", "issue_id": 2924, "user": {"repos_url": "https://api.github.com/users/tiegz/repos", "type": "User", "html_url": "https://github.com/tiegz", "starred_url": "https://api.github.com/users/tiegz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiegz/subscriptions", "following_url": "https://api.github.com/users/tiegz/following{/other_user}", "gravatar_id": "f86911c918d9c3eb1644189a50d74ccb", "organizations_url": "https://api.github.com/users/tiegz/orgs", "url": "https://api.github.com/users/tiegz", "gists_url": "https://api.github.com/users/tiegz/gists{/gist_id}", "avatar_url": "https://2.gravatar.com/avatar/f86911c918d9c3eb1644189a50d74ccb?d=https%3A%2F%2Fidenticons.github.com%2F64eec0c3fb6b12c43f51ec9e9c773fed.png", "id": 5054, "events_url": "https://api.github.com/users/tiegz/events{/privacy}", "login": "tiegz", "received_events_url": "https://api.github.com/users/tiegz/received_events", "followers_url": "https://api.github.com/users/tiegz/followers"}, "body": "+1 \r\n\r\nI ran into this exact bug as well on 3.2.3, but it happens with simple joins too. I have a feeling the patch is not the right approach, but here's a failing test case I wrote without has_many through, in ```calculations_test```:\r\n\r\n```  \r\ndef test_should_count_primary_table_in_joined_table_with_uniq\r\n    queries = assert_sql { Account.joins(:firm).uniq(:id).count }\r\n    assert_equal 1, queries.length\r\n    assert_match(/SELECT COUNT(DISTINCT `accounts`.`id`)/, queries.first)\r\n  end\r\n# ...\r\n# <\"SELECT DISTINCT COUNT(*) FROM `accounts` INNER JOIN `companies` ON `companies`.`id` = `accounts`.`firm_id`\"> \r\n# expected to be =~\r\n# </SELECT COUNT(DISTINCT `accounts`.`id`)/>.\r\n```\r\n\r\n^ The issue is that currently it will count the number of joined rows, rather than the number of distinct account ids.\r\n\r\nYou can specify the count column as an option like this:\r\n\r\n```\r\nAccount.joins(:firm).uniq.count(:id)\r\n```\r\n\r\n... but it still incorrectly produces this select statement:\r\n\r\n```\r\nSELECT DISTINCT COUNT(`accounts`.`id`)\r\n```\r\n", "_id": {"$oid": "52383d88bd3543c1510104bc"}, "html_url": "https://github.com/rails/rails/pull/2924#issuecomment-5374574"}
