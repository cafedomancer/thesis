{"updated_at": "2012-03-17T10:11:42Z", "repo": "rails", "created_at": "2012-03-17T10:11:42Z", "owner": "rails", "url": "https://api.github.com/repos/rails/rails/issues/comments/4553028", "id": 4553028, "issue_url": "https://api.github.com/repos/rails/rails/issues/5476", "issue_id": 5476, "user": {"repos_url": "https://api.github.com/users/tandem-softworks/repos", "type": "User", "html_url": "https://github.com/tandem-softworks", "starred_url": "https://api.github.com/users/tandem-softworks/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tandem-softworks/subscriptions", "following_url": "https://api.github.com/users/tandem-softworks/following{/other_user}", "gravatar_id": "34a16f98f4ba99dcb241c8ddb3a5446c", "organizations_url": "https://api.github.com/users/tandem-softworks/orgs", "url": "https://api.github.com/users/tandem-softworks", "gists_url": "https://api.github.com/users/tandem-softworks/gists{/gist_id}", "avatar_url": "https://2.gravatar.com/avatar/34a16f98f4ba99dcb241c8ddb3a5446c?d=https%3A%2F%2Fidenticons.github.com%2F1da9a1d31a36bd743246c9900650b600.png", "id": 1497057, "events_url": "https://api.github.com/users/tandem-softworks/events{/privacy}", "login": "tandem-softworks", "received_events_url": "https://api.github.com/users/tandem-softworks/received_events", "followers_url": "https://api.github.com/users/tandem-softworks/followers"}, "body": "No! Aren't the two lines are equivalent, since \"==\" means same 'id'. I actually prefer the second version because it highlights the problem. Although \"target_record == existing_record\" they may be different objects, which is the root of the problem (IdentityMap could have helped ...).\r\n\r\nThe problem with the previous code is the control structure. The lookup in the target cannot be constrained by \"unless association.loaded?\". So the alternative would be something like:\r\n\r\n```ruby\r\n        elsif existing_record = existing_records.detect { |record| record.id.to_s == attributes['id'].to_s }\r\n          if target_record = association.target.detect { |record| record.id.to_s == attributes['id'].to_s }\r\n            existing_record = target_record\r\n          else\r\n            association.target << existing_record # or association.add_to_target(existing_record)\r\n          end\r\n          if !call_reject_if(association_name, attributes)\r\n            assign_to_or_mark_for_destruction(existing_record, attributes, options[:allow_destroy], assignment_opts)\r\n          end\r\n```\r\n\r\nDo you like this better?\r\n", "_id": {"$oid": "523ec1f2bd354364b901270d"}, "html_url": "https://github.com/rails/rails/pull/5476#issuecomment-4553028"}
