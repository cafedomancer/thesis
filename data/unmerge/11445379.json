{"body": "Fixes this issue also seen by others in Foreigner: https://github.com/matthuhiggins/foreigner/issues/61\r\n\r\nThe problem that it resolves is that if you have system triggers (e.g. RI_ConstraintTrigger_1234567) that the database user does not have the ability to disable or enable, then when the postgres adapter's disable_referential_integrity method is called by the database_cleaner gem, it will fail and fail to reenable. The pg user has rights to user triggers but should not have permissions to system triggers, at least in certain environments. Falling back to attempting to disable and reenable user triggers instead avoids this issue while providing functionality that should be backwards-compatible with recent versions of Rails:\r\n\r\n    /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:652:in `async_exec': PG::Error: ERROR:  permission denied: \"RI_ConstraintTrigger_1234567\" is a system trigger (ActiveRecord::StatementInvalid)\r\n    : (SQL here)\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:652:in `block in execute'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/abstract_adapter.rb:280:in `block in log'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activesupport-3.2.9/lib/active_support/notifications/instrumenter.rb:20:in `instrument'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/abstract_adapter.rb:275:in `log'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:651:in `execute'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:528:in `ensure in disable_referential_integrity'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:528:in `disable_referential_integrity'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/active_record/deletion.rb:57:in `clean'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/base.rb:39:in `clean_with'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/configuration.rb:85:in `block in clean_with'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/configuration.rb:85:in `each'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/configuration.rb:85:in `clean_with'\r\n      from /.../jenkins/jobs/my_application-some_branch/workspace/spec/support/database_cleaner.rb:8:in `block (2 levels) in <top (required)>'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:23:in `instance_eval'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:23:in `run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:72:in `block in run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:72:in `each'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:72:in `run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:424:in `run_hook'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/command_line.rb:27:in `block in run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/reporter.rb:34:in `report'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/command_line.rb:25:in `run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/runner.rb:80:in `run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/runner.rb:17:in `block in autorun'/.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:652:in `async_exec': PG::Error: ERROR:  permission denied: \"RI_ConstraintTrigger_1234567\" is a system trigger (ActiveRecord::StatementInvalid)\r\n    : (SQL here)\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:652:in `block in execute'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/abstract_adapter.rb:280:in `block in log'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activesupport-3.2.9/lib/active_support/notifications/instrumenter.rb:20:in `instrument'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/abstract_adapter.rb:275:in `log'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:651:in `execute'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:528:in `ensure in disable_referential_integrity'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/activerecord-3.2.9/lib/active_record/connection_adapters/postgresql_adapter.rb:528:in `disable_referential_integrity'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/active_record/deletion.rb:57:in `clean'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/base.rb:39:in `clean_with'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/configuration.rb:85:in `block in clean_with'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/configuration.rb:85:in `each'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/database_cleaner-0.9.1/lib/database_cleaner/configuration.rb:85:in `clean_with'\r\n      from /.../jenkins/jobs/my_application-some_branch/workspace/spec/support/database_cleaner.rb:8:in `block (2 levels) in <top (required)>'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:23:in `instance_eval'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:23:in `run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:72:in `block in run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:72:in `each'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:72:in `run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/hooks.rb:424:in `run_hook'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/command_line.rb:27:in `block in run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/reporter.rb:34:in `report'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/command_line.rb:25:in `run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/runner.rb:80:in `run'\r\n      from /.../jenkins/.rvm/gems/ruby-1.9.3-p194@my_application/gems/rspec-core-2.12.1/lib/rspec/core/runner.rb:17:in `block in autorun'\r\n\r\nSorry for the bad commit this morning. Thought it was the same that I had reviewed and tested Friday. Latest patch version has been tested in our CI environment this morning and this last change fixes the original issue like the original patch.\r\n\r\nI actually like the original patch I provided better, but I thought this was cleaner-looking and perhaps more backwards-compatible.\r\n\r\nEven better would be to look at the pg_trigger table in postgres to determine what was enabled before and only reenable that which was previously enabled, but I'm not sure whether that would be too tied to a specific version of postgres vs. the current implementation which tries to make as few assumptions as possible.", "url": "https://api.github.com/repos/rails/rails/issues/comments/11445379", "created_at": "2012-12-17T15:15:23Z", "html_url": "https://github.com/rails/rails/pull/8498#issuecomment-11445379", "updated_at": "2012-12-17T15:17:53Z", "repo": "rails", "issue_id": 8498, "user": {"following_url": "https://api.github.com/users/garysweaver/following{/other_user}", "events_url": "https://api.github.com/users/garysweaver/events{/privacy}", "organizations_url": "https://api.github.com/users/garysweaver/orgs", "url": "https://api.github.com/users/garysweaver", "gists_url": "https://api.github.com/users/garysweaver/gists{/gist_id}", "html_url": "https://github.com/garysweaver", "subscriptions_url": "https://api.github.com/users/garysweaver/subscriptions", "avatar_url": "https://0.gravatar.com/avatar/8838005371ab9c0b1d40f0504bf8832a?d=https%3A%2F%2Fidenticons.github.com%2F4eb6720c6cd70ee9e67ca6e4dc12e3df.png", "repos_url": "https://api.github.com/users/garysweaver/repos", "received_events_url": "https://api.github.com/users/garysweaver/received_events", "gravatar_id": "8838005371ab9c0b1d40f0504bf8832a", "starred_url": "https://api.github.com/users/garysweaver/starred{/owner}{/repo}", "login": "garysweaver", "type": "User", "id": 92330, "followers_url": "https://api.github.com/users/garysweaver/followers"}, "owner": "rails", "_id": {"$oid": "5237f2abbd3543c15100a69b"}, "id": 11445379, "issue_url": "https://api.github.com/repos/rails/rails/issues/8498"}
